<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ name }} - Image Viewer</title>
    <script>
        document.addEventListener('keydown', function (event) {
            // Check if the right arrow key (ArrowRight) or left arrow key (ArrowLeft) is pressed
            if (event.key === 'ArrowRight') {
                // Navigate to the next image
                window.location.href = '/{{ next }}';
            } else if (event.key === 'ArrowLeft') {
                // Navigate to the previous image
                window.location.href = '/{{ prev }}';
            }
        });
    </script>
    <style>
        /* Flexbox for two columns layout */
        .content {
            display: flex;
            justify-content: space-between;
        }

        .column {
            width: 45%;
        }

        .column h3 {
            margin-top: 0;
        }

        /* Styling the image */
        img {
            max-width: 100%;
            height: auto;
        }

        /* Adjust the form and annotation list */
        .annotations-list {
            list-style-type: none;
            padding: 0;
        }

        .annotations-list li {
            margin-bottom: 5px;
        }

        .form-group {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h1>{{ name }}</h1>


    <!-- Flex container for two columns -->
    <div class="content">
        <!-- Annotations Column -->
        <div class="column">
            <h2>Image:</h2>
            <img src="{{ image_file }}" alt="Image for {{ name }}" />
            <h3>Annotations:</h3>
            <ul class="annotations-list">
                {% for annotation in annotations %}
                <li>{{ annotation }}</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Validation Form Column -->
        <div class="column">
            <!-- Automatically validate EAN-13 on input -->
            <label for="ean13">EAN-13:</label>
            <input type="text" id="ean13" name="ean13" value="{{ ean }}" placeholder="Enter or check EAN-13 here" />
            <div id="ean-warning" style="color: red;">Invalid EAN-13.</div>
            <div id="ean-success" style="color: green; display: none;">Valid EAN-13.</div>
            <button id="submit-btn" disabled>Check Open Food Facts for EAN</button>
            <div id="product-info"></div>
            <script>
                // Get references to the success and warning elements
                var success = document.getElementById('ean-success');
                var warning = document.getElementById('ean-warning');
                var submitButton = document.getElementById('submit-btn');
                var eanInputField = document.getElementById('ean13');
                var productInfo = document.getElementById('product-info');

                // Function to validate the EAN
                async function validateEAN() {
                    var eanInput = eanInputField.value;
                    const response = await fetch('/validate_ean/' + eanInput);
                    if (response.ok) {
                        warning.style.display = 'none';
                        success.style.display = 'block';
                        submitButton.disabled = false;
                    } else {
                        warning.style.display = 'block';
                        success.style.display = 'none';
                        submitButton.disabled = true;
                    }
                }

                async function checkOff() {
                    var eanInput = eanInputField.value;
                    const response = await fetch('/check_off/' + eanInput);
                    // Check if the response is okay
                    if (response.ok) {
                        // Set the inner HTML of the productInfo div
                        productInfo.innerHTML = await response.text();;
                    }
                }
                // Add event listener for input changes
                eanInputField.addEventListener('input', validateEAN);

                // Run the validation on page load
                window.addEventListener('load', validateEAN);

                // If button is clicked, check open food facts if they have the product
                submitButton.addEventListener('click', checkOff)

                // Add function to save EAN to database
                async function saveEAN(ean) {
                    try {
                        const response = await fetch(`/update_ean/{{ name }}/${ean}`, {
                            method: 'POST'
                        });
                        if (!response.ok) {
                            console.error('Failed to save EAN');
                        }
                    } catch (error) {
                        console.error('Error saving EAN:', error);
                    }
                }

                // Modify validateEAN function to save valid EANs
                async function validateEAN() {
                    var eanInput = eanInputField.value;
                    const response = await fetch('/validate_ean/' + eanInput);
                    if (response.ok) {
                        warning.style.display = 'none';
                        success.style.display = 'block';
                        submitButton.disabled = false;
                        // Save valid EAN to database
                        await saveEAN(eanInput);
                    } else {
                        warning.style.display = 'block';
                        success.style.display = 'none';
                        submitButton.disabled = true;
                    }
                }
            </script>
            <!-- Add this in the Validation Form Column div, before the GPS Information -->
            {% if not annotations %}
            <div class="ocr-section">
                <p>No annotations found for this image.</p>
                <button id="run-ocr-btn">Run OCR</button>
                <div id="ocr-status"></div>
            </div>
            <script>
                const ocrButton = document.getElementById('run-ocr-btn');
                const ocrStatus = document.getElementById('ocr-status');

                async function runOCR() {
                    ocrButton.disabled = true;
                    ocrStatus.textContent = 'Running OCR...';

                    try {
                        const response = await fetch('/run_ocr/{{ name }}');
                        const data = await response.json();

                        if (response.ok) {
                            ocrStatus.textContent = 'OCR completed. Refreshing page...';
                            setTimeout(() => window.location.reload(), 1500);
                        } else {
                            ocrStatus.textContent = `Error: ${data.error}`;
                            ocrButton.disabled = false;
                        }
                    } catch (error) {
                        ocrStatus.textContent = `Error: ${error.message}`;
                        ocrButton.disabled = false;
                    }
                }

                ocrButton.addEventListener('click', runOCR);
            </script>
            {% endif %}
            <!-- GPS Information Column -->
            <h3>GPS Information:</h3>
            <p><strong>Latitude:</strong> {{ latitude }}</p>
            <p><strong>Longitude:</strong> {{ longitude }}</p>
            <p><strong>Created At:</strong> {{ created_at }}</p>
        </div>

    </div>

    <div style="clear: both;"></div>

    <!-- Navigation Links -->
    <div>
        <a href="/{{ prev }}">Previous Image</a> |
        <a href="/{{ next }}">Next Image</a>
    </div>

    <a href="/">Back to Image List</a>
</body>

</html>