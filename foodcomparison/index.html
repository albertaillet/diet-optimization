<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <title>Nutrition comparison</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <div class="container">
            <span class="navbar-brand">Nutrition Comparison</span>
            <div class="w-100 mt-2">
                <div class="row g-2">
                    <div class="col-md-6">
                        <select class="form-select" id="food1">
                            <option value="">Select first food</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <select class="form-select" id="food2">
                            <option value="">Select second food</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex gap-4 mt-2">
                    <div class="d-flex align-items-center">
                        <span class="legend-color bg-primary"></span>
                        <span id="legend-food1">Food 1</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="legend-color" style="background: orange"></span>
                        <span id="legend-food2">Food 2</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 140px;">
        <div id="chart" style="height: 600px;"></div>
    </div>
</body>

<script>
const calnut_link = "calnut.csv";
const nutrients_link = "nutrients.txt";
let nutrientsToCompare = [];
let globalData = [];

function stringToNumber(str) {
    if (!isNaN(str)) return parseFloat(str);
    return parseFloat(str.replace(',', '.'));
}

d3.text(nutrients_link).then(text => {
    nutrientsToCompare = text.split('\n').filter(n => n.trim() !== '');

    d3.csv(calnut_link, d3.autoType).then(data => {
        globalData = data;
        const uniqueFoods = [...new Set(data.map(d => d.FOOD_LABEL))];
        const food1Select = document.getElementById('food1');
        const food2Select = document.getElementById('food2');
        uniqueFoods.forEach(food => {
            food1Select.add(new Option(food, food));
            food2Select.add(new Option(food, food));
        });

        // Load saved selections from localStorage
        const savedFood1 = localStorage.getItem('food1');
        const savedFood2 = localStorage.getItem('food2');
        if (savedFood1) food1Select.value = savedFood1;
        if (savedFood2) food2Select.value = savedFood2;

        [food1Select, food2Select].forEach(select => {
            select.addEventListener('change', () => {
                // Save selections to localStorage
                localStorage.setItem('food1', food1Select.value);
                localStorage.setItem('food2', food2Select.value);
                updateChart();
            });
        });

        // Initial chart update
        updateChart();
    });
});

function updateChart() {
    const food1 = document.getElementById('food1').value;
    const food2 = document.getElementById('food2').value;

    // Update legend text
    document.getElementById('legend-food1').textContent = food1;
    document.getElementById('legend-food2').textContent = food2;

    if (!food1 || !food2) return;

    const food1Data = globalData.filter(d => d.FOOD_LABEL === food1);
    const food2Data = globalData.filter(d => d.FOOD_LABEL === food2);

    const chartData = nutrientsToCompare.map(nutrient => {
        const food1Nutrient = food1Data.find(d => d.CONST_LABEL === nutrient);
        const food2Nutrient = food2Data.find(d => d.CONST_LABEL === nutrient);
        return {
            nutrient,
            unit: food1Nutrient.CONST_LABEL.split('_').slice(-1)[0],
            lower_bound_1: stringToNumber(food1Nutrient.LB),
            upper_bound_1: stringToNumber(food1Nutrient.UB),
            mean_1: stringToNumber(food1Nutrient.MB),
            lower_bound_2: stringToNumber(food2Nutrient.LB),
            upper_bound_2: stringToNumber(food2Nutrient.UB),
            mean_2: stringToNumber(food2Nutrient.MB),
        };
    });

    const margin = { top: 30, right: 90, bottom: 40, left: 150 };
    const width = 800;
    const height = 2200;

    d3.select('#chart').html('');
    const svg = d3.select('#chart')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    const y = d3.scaleBand()
        .domain(nutrientsToCompare)
        .range([margin.top, height - margin.bottom])
        .padding(0.1);

    svg.append('g')
        .attr('transform', `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));

    // Create separate scales for each nutrient
    chartData.forEach(d => {
        const maxVal = Math.max(d.mean_1, d.mean_2, d.upper_bound_1, d.upper_bound_2, 2);
        const x = d3.scaleLinear()
            .domain([0, maxVal])
            .range([0, 300]);

        // Add bars for food1
        svg.append('rect')
            .attr('class', 'bar-food1')
            .attr('x', margin.left)
            .attr('y', y(d.nutrient))
            .attr('width', x(d.mean_1))
            .attr('height', y.bandwidth() / 2)
            .attr('fill', 'steelblue');

        // Add bars for food2
        svg.append('rect')
            .attr('class', 'bar-food2')
            .attr('x', margin.left)
            .attr('y', y(d.nutrient) + y.bandwidth() / 2)
            .attr('width', x(d.mean_2))
            .attr('height', y.bandwidth() / 2)
            .attr('fill', 'orange');

        // Add error bars for food1
        svg.append('line')
            .attr('x1', margin.left + x(d.lower_bound_1))
            .attr('x2', margin.left + x(d.upper_bound_1))
            .attr('y1', y(d.nutrient) + y.bandwidth() / 4)
            .attr('y2', y(d.nutrient) + y.bandwidth() / 4)
            .attr('stroke', 'black')
            .attr('stroke-width', 1)
            .attr('opacity', 0.5);

        // Vertical lines for food1
        svg.append('line')
            .attr('x1', margin.left + x(d.lower_bound_1))
            .attr('x2', margin.left + x(d.lower_bound_1))
            .attr('y1', y(d.nutrient) + y.bandwidth() / 8)
            .attr('y2', y(d.nutrient) + 3 * y.bandwidth() / 8)
            .attr('stroke', 'black')
            .attr('stroke-width', 1)
            .attr('opacity', 0.5);

        svg.append('line')
            .attr('x1', margin.left + x(d.upper_bound_1))
            .attr('x2', margin.left + x(d.upper_bound_1))
            .attr('y1', y(d.nutrient) + y.bandwidth() / 8)
            .attr('y2', y(d.nutrient) + 3 * y.bandwidth() / 8)
            .attr('stroke', 'black')
            .attr('stroke-width', 1)
            .attr('opacity', 0.5);

        // Add error bars for food2
        svg.append('line')
            .attr('x1', margin.left + x(d.lower_bound_2))
            .attr('x2', margin.left + x(d.upper_bound_2))
            .attr('y1', y(d.nutrient) + 3 * y.bandwidth() / 4)
            .attr('y2', y(d.nutrient) + 3 * y.bandwidth() / 4)
            .attr('stroke', 'black')
            .attr('stroke-width', 1)
            .attr('opacity', 0.5);

        // Vertical lines for food2
        svg.append('line')
            .attr('x1', margin.left + x(d.lower_bound_2))
            .attr('x2', margin.left + x(d.lower_bound_2))
            .attr('y1', y(d.nutrient) + 5 * y.bandwidth() / 8)
            .attr('y2', y(d.nutrient) + 7 * y.bandwidth() / 8)
            .attr('stroke', 'black')
            .attr('stroke-width', 1)
            .attr('opacity', 0.5);

        svg.append('line')
            .attr('x1', margin.left + x(d.upper_bound_2))
            .attr('x2', margin.left + x(d.upper_bound_2))
            .attr('y1', y(d.nutrient) + 5 * y.bandwidth() / 8)
            .attr('y2', y(d.nutrient) + 7 * y.bandwidth() / 8)
            .attr('stroke', 'black')
            .attr('stroke-width', 1)
            .attr('opacity', 0.5);

        // Add value labels
        svg.append('text')
            .attr('x', margin.left + x(d.upper_bound_1) + 5)
            .attr('y', y(d.nutrient) + y.bandwidth() / 4)
            .attr('dy', '0.35em')
            .text(`${d.mean_1.toFixed(1)} ${d.unit}`);

        svg.append('text')
            .attr('x', margin.left + x(d.upper_bound_2) + 5)
            .attr('y', y(d.nutrient) + y.bandwidth() * 3/4)
            .attr('dy', '0.35em')
            .text(`${d.mean_2.toFixed(1)} ${d.unit}`);
    });
}
</script>
</html>